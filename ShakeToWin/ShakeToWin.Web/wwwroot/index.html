<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Shake To Win</title>
	<link rel="stylesheet" href="styles.css" />
	<script src="scripts/api.js"></script>
	<script type="text/javascript">
		const stateRefreshRate = 1000;
		var lastPeakAcceleration = 0;
		var compPeakAcceleration = [0, 0, 0, 0];
		var state = {};

		function refreshSate(playroom) {
			state.playroom = playroom;

			var compAcceleration = state.playroom.reports
				.filter(r => r.userId !== state.userId)
				.map(r => r.acceleration);

			for (var i = 0; i < compAcceleration.length; i++) {
				if (compAcceleration[i] > compPeakAcceleration[i]) {
					compPeakAcceleration[i] = compAcceleration[i];
				}
			}
		}

		function handleAnimation() {
			const decrease = 0.05;
			lastPeakAcceleration -= decrease;
			if (lastPeakAcceleration < 0) {
				lastPeakAcceleration = 0;
			}
			var playerAccelerationControl = document.getElementById('playerAcceleration');
			playerAccelerationControl.parentElement.style.height = 2 + lastPeakAcceleration + "rem";
			playerAccelerationControl.parentElement.style.top = 28 - lastPeakAcceleration + "rem";

			if (state.playroom) {
				for (var i = 0; i < compPeakAcceleration.length; i++) {
					compPeakAcceleration[i] -= decrease;
					if (compPeakAcceleration[i] < 0) {
						compPeakAcceleration[i] = 0;
					}
					var compAccelerationControl = document.getElementById('competitor' + i);
					compAccelerationControl.parentElement.style.height = 2 + compPeakAcceleration[i] + "rem";
					compAccelerationControl.parentElement.style.top = 28 - compPeakAcceleration[i] + "rem";
				}
			}
		}

		var lastMotionHandling = Date.now();
		function handleMotion(e) {
			if (Date.now() - lastMotionHandling < stateRefreshRate) {
				return;
			}

			var x = Math.ceil(e.accelerationIncludingGravity.x);
			var y = Math.ceil(e.accelerationIncludingGravity.y);
			var z = Math.ceil(e.accelerationIncludingGravity.z);

			const earthGravity = 9.8;
			var lastAcceleration = Math.ceil(Math.abs(x) + Math.abs(y) + Math.abs(z) - earthGravity);

			if (lastAcceleration > lastPeakAcceleration) {
				lastPeakAcceleration = lastAcceleration;
			}

			lastMotionHandling = Date.now();
		}

		function grantMotionAccess() {
			if (typeof DeviceMotionEvent.requestPermission === 'function') { // iOS 13
				DeviceMotionEvent
					.requestPermission()
					.then(response => {
						if (response === 'granted') {
							window.addEventListener('devicemotion', handleMotion);
						}
					})
					.catch(alert);
			} else { // Other OS
				window.addEventListener('devicemotion', handleMotion);
			}

			document.getElementById('grantMotionAccess').remove();
		}

		function startReporting() {
			setInterval(() =>
				sendReport({
					roomId: state.playroom.id,
					userId: state.userId,
					acceleration: lastPeakAcceleration
				}),
				stateRefreshRate);
		}

		function startRefreshing() {
			setInterval(() =>
				getPlayroomState(state.playroom.id)
					.then(refreshSate),
				stateRefreshRate);
		}

		window.onload = () =>
			connect()
				.then(connection => state = connection)
				.then(startReporting)
				.then(startRefreshing);

		setInterval(handleAnimation, 1);
	</script>
</head>
<body>
	<div id="screen">
		<div id="grantMotionAccess" class="gameButton" style="top:2rem" onclick="grantMotionAccess()">
			<div>Grant Motion Access</div>
		</div>
		<div class="gameButton" style="top: 28rem; width: 2rem;">
			<div id="playerAcceleration"></div>
		</div>
		<div class="gameButton" style="top: 28rem; width: 2rem; height: 0rem; left: 5rem; background-color: blueviolet">
			<div id="competitor0"></div>
		</div>
		<div class="gameButton" style="top: 28rem; width: 2rem; height: 0rem; left: 8rem; background-color: darkblue">
			<div id="competitor1"></div>
		</div>
		<div class="gameButton" style="top: 28rem; width: 2rem; height: 0rem; left: 11rem; background-color: indigo">
			<div id="competitor2"></div>
		</div>
		<div class="gameButton" style="top: 28rem; width: 2rem; height: 0rem; left: 14rem; background-color: sandybrown">
			<div id="competitor3"></div>
		</div>
	</div>
</body>
</html>
