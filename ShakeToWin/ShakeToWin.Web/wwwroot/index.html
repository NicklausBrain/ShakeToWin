<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Shake To Win</title>
	<link rel="stylesheet" href="styles.css" />
	<script src="scripts/api.js"></script>
	<script type="text/javascript">
		const stateRefreshRate = 1000;
		var lastPeakAcceleration = 0;
		var lastAcceleration = 0;
		var state = {};

		function refreshSate(playroom) {
			state.playroom = playroom;
		}

		function handleAnimation() {
			lastPeakAcceleration -= 0.05;
			if (lastPeakAcceleration < 0) {
				lastPeakAcceleration = 0;
			}
			document.getElementById('acceleration').parentElement.style.height = 2 + lastPeakAcceleration + "rem";
			document.getElementById('acceleration').parentElement.style.top = 28 - lastPeakAcceleration + "rem";

			if (state.playroom) {
				var otherMax = state.playroom.reports.filter(r => r.userId !== state.userId).map(r => r.acceleration);
				document.getElementById('acceleration1').parentElement.style.height = 2 + otherMax[0] + "rem";
				document.getElementById('acceleration1').parentElement.style.top = 28 - otherMax[0] + "rem";
				document.getElementById('acceleration2').parentElement.style.height = 2 + otherMax[1] + "rem";
				document.getElementById('acceleration2').parentElement.style.top = 28 - otherMax[1] + "rem";
				document.getElementById('acceleration3').parentElement.style.height = 2 + otherMax[2] + "rem";
				document.getElementById('acceleration3').parentElement.style.top = 28 - otherMax[2] + "rem";
				document.getElementById('acceleration4').parentElement.style.height = 2 + otherMax[3] + "rem";
				document.getElementById('acceleration4').parentElement.style.top = 28 - otherMax[3] + "rem";
			}
		}

		var lastMotionHandling = Date.now();
		function handleMotion(e) {
			if (Date.now() - lastMotionHandling < stateRefreshRate) {
				return;
			}

			var x = Math.ceil(e.accelerationIncludingGravity.x);
			var y = Math.ceil(e.accelerationIncludingGravity.y);
			var z = Math.ceil(e.accelerationIncludingGravity.z);

			const earthGravity = 9.8;
			lastAcceleration  = Math.ceil(Math.abs(x) + Math.abs(y) + Math.abs(z) - earthGravity);

			if (lastAcceleration  > lastPeakAcceleration) {
				lastPeakAcceleration = lastAcceleration ;
			}

			lastMotionHandling = Date.now();
		}

		function grantMotionAccess() {
			if (typeof DeviceMotionEvent.requestPermission === 'function') { // iOS 13
				DeviceMotionEvent
					.requestPermission()
					.then(response => {
						if (response === 'granted') {
							window.addEventListener('devicemotion', handleMotion);
						}
					})
					.catch(alert);
			} else { // Other OS
				window.addEventListener('devicemotion', handleMotion);
			}

			document.getElementById('grantMotionAccess').remove();
		}

		function startReporting() {
			setInterval(() =>
				sendReport({
					roomId: state.playroom.id,
					userId: state.userId,
					acceleration: lastPeakAcceleration
				}),
				stateRefreshRate);
		}

		function startRefreshing() {
			setInterval(() =>
				getPlayroomState(state.playroom.id)
					.then(refreshSate),
				stateRefreshRate);
		}

		window.onload = () =>
			connect()
			.then(connection => state = connection)
			.then(startReporting)
			.then(startRefreshing);

		setInterval(handleAnimation, 1);
	</script>
</head>
<body>
	<div id="screen">
		<div id="grantMotionAccess" class="menuButton" style="top:2rem" onclick="grantMotionAccess()">
			<div>Grant Motion Access</div>
		</div>
		<div class="menuButton" style="top: 28rem; width: 2rem;">
			<div id="acceleration"></div>
		</div>
		<div class="menuButton" style="top: 28rem; width: 2rem; height: 0rem; left: 5rem; background-color: blueviolet">
			<div id="acceleration1"></div>
		</div>
		<div class="menuButton" style="top: 28rem; width: 2rem; height: 0rem; left: 8rem; background-color: darkblue">
			<div id="acceleration2"></div>
		</div>
		<div class="menuButton" style="top: 28rem; width: 2rem; height: 0rem; left: 11rem; background-color: indigo">
			<div id="acceleration3"></div>
		</div>
		<div class="menuButton" style="top: 28rem; width: 2rem; height: 0rem; left: 14rem; background-color: sandybrown">
			<div id="acceleration4"></div>
		</div>
	</div>
</body>
</html>
